<div class="page_new">
	<div class="container">
		<div class="row">
			<h2 class="title mt-2 fadein">Post review</h2>

			<% if @review.errors.any? %>
		        <div id="error_explanation">
		            <h3><%= @review.errors.count %>error prohibited this obj from being saved:</h3>
		            <ul>
		                <% @review.errors.full_messages.each do |message| %>
		                <li><%= message %></li>
		                <% end %>
		            </ul>
		        </div>
		    <% end %>

			<%= form_with model: @review, url:reviews_path(@review.id), method: :post, local: true do |f| %>
				<table class="table table_new_all fadein" >
					<tr class="table_new">
						<th class="table_new"><%= f.label 'restaurant name' %></th>
						<td class="table_new"><%= f.text_field :restaurant_name, :placeholder => "店名" %></td>
					</tr>
					<tr class="table_new">
						<th class="table_new">
						<div class="form-group" id="star" style="width:300px;">
							<strong>Rate</strong>
							<%= f.hidden_field :rate, id: :review_star %>
						</div>
						</th class="table_new">
						<script>
						  $('#star').raty({
						   size: 35,
						   starOff:  "/assets/star-off.png",
						   starOn: "/assets/star-on.png",
						   starHalf: "/assets/star-half.png",
						   scoreName: 'review[rate]',
						   half: true,
						 });
						</script>
					</tr>

					<tr class="table_new">
						<th>Country,City</th>
						<td class="country_box">
							<%= f.text_field :country, placeholder: "国名(例:France) 半角英", class: 'country', id: :country, autocomplete: 'off' %>
							<%= f.text_field :city, placeholder: "都市名(例:Paris) 半角英", class: 'city',id: :city, autocomplete: 'off' %>
							<script>
							  $( function() {
							    $( "#country" ).autocomplete({
							      autoFocus: true,
							      source: "/reviews/auto_complete.json",
							      minLength: 1,
							    });
							  });
							$( function() {
							    $( "#city" ).autocomplete({
								    autoFocus: true,
								    source: "/reviews/auto_complete_cities.json",
							      	minLength: 1
							    });
							});
							</script>
						</td>
					</tr>

					<tr class="table_new">
						<th class="table_new">Address</th>
						<td class="table_new"><%= f.text_area :address,:size=>"30", :placeholder => "住所" %></td>
					</tr>

					<tr class="table_new">
						<th class="table_new">Budget</th>
						<td class="table_new">
							<%= f.select :currency, ['$',' EUR ','￡', '￥','Kr','Fr','₩','R','₺','₡','₪','₹','ரூ','₫','฿','؋','₱' ], {include_blank: '通貨を選択してください'} %>
							<%= f.text_field :budget,:placeholder => "予算(最低額) 15",class: "budget_box" %> 〜 <%= f.text_field :maximum_budget,:placeholder => "予算(上限額) 30",class: "budget_box" %></td>
					</tr>

					<tr class="table_new">
						<th class="table_new">Review</th>
						<td class="table_new"><%= f.text_area :review ,:size=>"50x8",:placeholder => "口コミ",class: 'review_area' %></td>
					</tr>
					<tr class="table_new">
						<th><%= f.label 'genre' %> </th>
	  					<td><%= f.collection_select :genre_id, Genre.where(is_active: true), :id, :genre_name, prompt: "ジャンルを選択してください --" %></td>
					</tr>

					<tr class="table_new">
						<th><%= f.label 'images' %></th>
						<td class="table_new">
							<div class="post__drop__box__container">
					            <div class="prev-content"></div>
					            <div class="label-content">
					              <label class="label-box" for="review_images_attributes_0_image" id="label-box--0">
					                <pre class="label-box__text-visible"></pre>
					              </label>
					            </div>
					            <div class="hidden-content">
					            	<%= f.fields_for :review_images do |image_form| %>
					            		<div>
						            		<% if image_form.object.image.present? %>
						            			<%= image_tag image_form.object.image.url, class: 'review_images' %>
						            		<% end %>
						            		<%= image_form.file_field :image, class: 'hidden-field' %>
					            		</div>
					            	<% end %>
					            </div>
					            <script type="text/javascript">
					            	$(document).on('turbolinks:load', function(){
									  $(function(){

									    //プレビューのhtmlを定義
									    function buildHTML(count) {
									      var html = `<div class="preview-box" id="preview-box__${count}">
									                    <div class="upper-box">
									                      <img src="" alt="preview">
									                    </div>
									                    <div class="lower-box">
									                      <div class="delete-box" id="delete_btn_${count}">
									                        <span>削除</span>
									                      </div>
									                    </div>
									                  </div>`
									      return html;
									    }

									    // 投稿編集時
									    //items/:i/editページへリンクした際のアクション=======================================
									    if (window.location.href.match(/\/reviews\/\d+\/edit/)){
									      //登録済み画像のプレビュー表示欄の要素を取得する
									      var prevContent = $('.label-content').prev();
									      labelWidth = (620 - $(prevContent).css('width').replace(/[^0-9]/g, ''));
									      $('.label-content').css('width', labelWidth);
									      //プレビューにidを追加
									      $('.preview-box').each(function(index, box){
									        $(box).attr('id', `preview-box__${index}`);
									      })
									      //削除ボタンにidを追加
									      $('.delete-box').each(function(index, box){
									        $(box).attr('id', `delete_btn_${index}`);
									      })
									      var count = $('.preview-box').length;
									      //プレビューが5あるときは、投稿ボックスを消しておく
									      if (count == 5) {
									        $('.label-content').hide();
									      }
									    }
									    //=============================================================================

									    // ラベルのwidth操作
									    function setLabel() {
									      //プレビューボックスのwidthを取得し、maxから引くことでラベルのwidthを決定
									      var prevContent = $('.label-content').prev();
									      labelWidth = (620 - $(prevContent).css('width').replace(/[^0-9]/g, ''));
									      $('.label-content').css('width', labelWidth);
									    }

									    // プレビューの追加
									    $(document).on('change', '.hidden-field', function() {
									      setLabel();
									      //hidden-fieldのidの数値のみ取得
									      var id = $(this).attr('id').replace(/[^0-9]/g, '');
									      //labelボックスのidとforを更新
									      $('.label-box').attr({id: `label-box--${id}`,for: `review_images_attributes_${id}_image`});
									      //選択したfileのオブジェクトを取得
									      var file = this.files[0];
									      var reader = new FileReader();
									      //readAsDataURLで指定したFileオブジェクトを読み込む
									      reader.readAsDataURL(file);
									      //読み込み時に発火するイベント
									      reader.onload = function() {
									        var image = this.result;
									        //プレビューが元々なかった場合はhtmlを追加
									        if ($(`#preview-box__${id}`).length == 0) {
									          var count = $('.preview-box').length;
									          var html = buildHTML(id);
									          //ラベルの直前のプレビュー群にプレビューを追加
									          var prevContent = $('.label-content').prev();
									          $(prevContent).append(html);
									        }
									        //イメージを追加
									        $(`#preview-box__${id} img`).attr('src', `${image}`);
									        var count = $('.preview-box').length;
									        //プレビューが5個あったらラベルを隠す
									        if (count == 5) {
									          $('.label-content').hide();
									        }

									        //プレビュー削除したフィールドにdestroy用のチェックボックスがあった場合、チェックを外す=============
									        if ($(`#review_images_attributes_${id}__destroy`)){
									          $(`#review_images_attributes_${id}__destroy`).prop('checked',false);
									        }
									        //=============================================================================

									        //ラベルのwidth操作
									        setLabel();
									        //ラベルのidとforの値を変更
									        if(count < 5){
									          $('.label-box').attr({id: `label-box--${count}`,for: `review_images_attributes_${count}_image`});
									        }
									      }
									    });

									    // 画像の削除
									    $(document).on('click', '.delete-box', function() {
									      var count = $('.preview-box').length;
									      setLabel(count);
									      var id = $(this).attr('id').replace(/[^0-9]/g, '');
									      $(`#preview-box__${id}`).remove();

									      //新規登録時と編集時の場合分け==========================================================

									      //新規投稿時
									      //削除用チェックボックスの有無で判定
									      if ($(`#review_images_attributes_${id}__destroy`).length == 0) {
									        //フォームの中身を削除
									        $(`#review_images_attributes_${id}_image`).val("");
									        var count = $('.preview-box').length;
									        //5個めが消されたらラベルを表示
									        if (count == 4) {
									          $('.label-content').show();
									        }
									        setLabel(count);
									        if(id < 5){
									          $('.label-box').attr({id: `label-box--${id}`,for: `review_images_attributes_${id}_image`});

									        }
									      } else {

									        //投稿編集時
									        $(`#review_images_attributes_${id}__destroy`).prop('checked',true);
									        //5個めが消されたらラベルを表示
									        if (count == 4) {
									          $('.label-content').show();
									        }

									        //ラベルのwidth操作
									        setLabel();
									        //ラベルのidとforの値を変更
									        //削除したプレビューのidによって、ラベルのidを変更する
									        if(id < 5){
									          $('.label-box').attr({id: `label-box--${id}`,for: `review_images_attributes_${id}_image`});
									        }
									      }
									      //=============================================================================
									    });
									  });
									});
					            </script>
						</td>
					</tr>

					<tr class="table_new">
						<th></th>
						<th></th>
					<td class="table_new pb-2"><%= f.submit 'post', class: "btn btn-outline-secondary post_btn mb-20" %></td>
					</tr>

				</table>
			<% end %>
		</div>
	</div>
</div>